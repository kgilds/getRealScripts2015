---
title: "healthy_relationships"
author: "Kevin Gilds, MPA"
date: "May 28, 2016"
output: html_document
---


```{r hr_import_libaries, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(pander)
library(ggplot2)
library(sqldf)
library(psych)
library(knitr)
library(gridExtra)
library(effsize)
library(likert)
setwd("C:/Users/kevin/Dropbox/GetReal/Data/sqlite")


### Make connection with database
getReal_2016db<- dbConnect(SQLite(), dbname="outcome_history.sqlite")




```


```{r load outcome surveys 2016, echo=FALSE}

### Reade the girl_pre_survey database for analysis. 
pre_outcomes <- dbReadTable(getReal_2016db, "girl_pre")

post_outcomes <- dbReadTable(getReal_2016db, "girl_post")

post_outcomes <- select(post_outcomes, girlCode, council, hr.avg)
###Select the variables of interest from the pre_survey
pre_outcomes <- select(pre_outcomes, girlCode, council, hr.avg)

history <- dbReadTable(getReal_2016db, "basic_view")


```


```{r read 2014 data, echo=FALSE}
setwd("C:/Users/kevin/Dropbox/GetReal/Reports/MY-2014-2015/Summ Evaluation Report/data")

getReal_2014db<- dbConnect(SQLite(), dbname="data_Final_GetReal_2014_2015.sqlite")

prepost2014 <- dbReadTable(getReal_2014db, "girl_pre_post_matched")

hr_prepost2014 <- prepost2014 %>%
    select(girlCode, council.x, hr.avg.x, hr.avg.y)


colnames (hr_prepost2014) [2] <- "council"
colnames (hr_prepost2014) [3] <- "Post"
colnames (hr_prepost2014) [4] <- "Pre"

hr_prepost2014 <- hr_prepost2014 %>%
    mutate("hr.diff" = Post -Pre) %>%
    mutate("Year_Id" = "M2")



hr_prepost2014 <- hr_prepost2014[, c(6,2,1,3,4,5)]



```




```{r connect_2013_hr_data, echo=FALSE}
pre_outcomes2013 <- dbReadTable(getReal_2016db, "girl_pre2013")

post_outcomes2013 <-dbReadTable(getReal_2016db, "girl_post2013")

hr_pre2013 <- pre_outcomes2013 %>%
    select(girlScoutCouncil, girlCode, hr_avg)


hr_post2013 <- post_outcomes2013 %>%
    select(girlScoutCouncil, girlCode, hr_avg)


```



```{r join_2013_hr_data, echo=FALSE}

hr_prepost2013 <- inner_join(hr_pre2013, hr_post2013, by="girlCode")



colnames(hr_prepost2013) [1] <- "council"
colnames(hr_prepost2013) [3] <- "Pre"
colnames(hr_prepost2013) [5]<- "Post"
    
hr_prepost2013 <- hr_prepost2013 %>%
    select(council, girlCode, Pre, Post)

hr_prepost2013 <- hr_prepost2013 %>%
    mutate(Year_Id = "M1")


hr_prepost2013 <- hr_prepost2013 %>%
    mutate(hr.diff = Post- Pre)

```


`






```{r "prep2015 data",echo=FALSE}

healthy_prepost <- inner_join(pre_outcomes, post_outcomes, by="girlCode")

#head(healthy_prepost)

colnames(healthy_prepost) [2] <- "council"
colnames(healthy_prepost) [3] <- "Pre"
colnames(healthy_prepost) [5] <- "Post"

#str(healthy_prepost)

healthy_prepost <-healthy_prepost %>%
    mutate(Year_Id = "M3")

healthy_prepost <- healthy_prepost %>%
    mutate(hr.diff = Post - Pre)





```



```{r council_filter_hr, echo=FALSE}
healthy_prepost <- healthy_prepost %>%
    filter(council == "West Central Council")

```




```{r echo=FALSE}



healthy_prepost <- healthy_prepost %>%
    select(girlCode, council, Pre, Post,Year_Id, hr.diff)


healthy_prepost <- healthy_prepost[,c(5,2, 1,3,4,6)]


hr_prepost2013 <- hr_prepost2013[,c(5,1,2,3,4,6)]



hr_all <-rbind(healthy_prepost, hr_prepost2013)

hr_all <- rbind(hr_all, hr_prepost2014)





hr_all$council <-sub("Girl Scouts of the Gateway Council Inc", "Gateway Council", fixed=TRUE, hr_all$council)




```


```{r test, echo=FALSE}

hr_high_df <- hr_all %>%
    filter(Year_Id == "M3" & Post >=4.45)

```




```{r test_tables, echo=FALSE, eval=TRUE}


hr_high <- with(hr_all,table(Year_Id,Post >=4.45))



hr_high_p <- prop.table(hr_high,1)

#pander(hr_high_p)


hr_not_achieved <- filter(hr_all, Year_Id == "M3" & Post < 4.45)



hr_increase_df <- filter(hr_not_achieved, Year_Id == "M3" & hr.diff >0)




hr_increase_tbl <-with(hr_increase_df, table(Year_Id, hr.diff > 0 ))

#hr_increase_tbl

hr_increase <- prop.table(hr_increase_tbl,1)

#pander(hr_increase)


hr_lowhigh <- filter(hr_all, Pre < 4.45 & Post >=4.45)

#nrow(hr_lowhigh)

#table(hr_lowhigh$Year_Id)


hr_imrove <- with(hr_lowhigh, table(Year_Id, Post >=4.45))


hr_imrove <- prop.table(hr_imrove,1)

#pander(hr_imrove)


```




```{r data_frame, echo=FALSE}
hr_df <- function (df) {
    if (df == "healthy_prepost"){
        dat1 <- healthy_prepost
} else if (df == "hr_prepost2013"){
        dat1 <-hr_prepost2013 
} else (df == "hr_prepost2014")
            data1 <-hr_prepost2014
        
    high <- filter (dat1, Post >=4.45)
    increase <-filter(dat1, Post < 4.45 & hr.diff >0)
    hr_temp <- nrow(high) + nrow(increase)
    hr_temp_1 <- hr_temp/nrow(dat1)
    hr_temp_1 <- round(hr_temp_1*100,2)
    hr_temp_1 <- paste0(hr_temp_1,"%", sep="")
    pander(hr_temp_1)

    
}



```


```{r achieved_function, echo=FALSE}

hr_achieved <- function(Year) {
    
    if(Year =="M3"){
        dat <-filter(hr_all, Year_Id =="M3")
        
    } else if(Year == "M1"){
        dat <- filter(hr_all, Year_Id =="M1")
    } else { (Year == "M2")
    dat <- filter(hr_all, Year_Id == "M2")
    }
    
    
    high <- filter(dat, Post >=4.45)
    hr_temp_1 <- nrow(high)/nrow(dat)
    hr_temp_1 <- round(hr_temp_1*100,2)
    hr_temp_1 <- paste0(hr_temp_1,"%", sep="")
    pander(hr_temp_1)
    
}

```





```{r success_function, echo=FALSE}
hr_sucess <-function(Year){
    
    if(Year =="M3"){
        dat <-filter(hr_all, Year_Id =="M3")
        
    } else if(Year == "M1"){
        dat <- filter(hr_all, Year_Id =="M1")
    } else { (Year == "M2")
    dat <- filter(hr_all, Year_Id == "M2")
    }
    
    
    high <- filter(dat, Post >=4.45)
    increase <-filter(dat, Post < 4.45 & hr.diff >0)
    hr_temp <- nrow(high) + nrow(increase)
    hr_temp_1 <- hr_temp/nrow(dat)
    hr_temp_1 <- round(hr_temp_1*100,2)
    hr_temp_1 <- paste0(hr_temp_1,"%", sep="")
    pander(hr_temp_1)
    

}



```










```{r low to high,  echo=FALSE}
hr_lowHigh <-function (Year){
    if(Year =="M3"){
        dat <-filter(hr_all, Year_Id =="M3")
        
    } else if(Year == "M1"){
        dat <- filter(hr_all, Year_Id =="M1")
    } else { (Year == "M2")
    dat <- filter(hr_all, Year_Id == "M2")
    }
    
    
    low <- filter(dat, Pre < 4.45 & Post >=4.45)
    low_1 <- nrow(low)/nrow(dat)
    hr_low_1 <- round(low_1*100,2)
    hr_low_1 <- paste0(hr_low_1, "%", sep="")
    pander(hr_low_1)
}


```






## Healthy Relationship Outcome 

Relationship skills are a critical component of success in all realms of life. 
The Healthy Relationship questions measures the behaviors and attitudes of the respondent regarding their relationship skills. Questions that measure healthy relationships skills include the following:


*Healthy Relationship Questions*

1. If I have a serious problem, I have people to talk with.
2. I let people know if they have hurt my feelings.
3. I let my friends know when I think they are good at something.
4. In any relationship - romantic or not - I make it clear when I don't feel comfortable.


The number of pre and post survey that could be matched is **`r nrow(healthy_prepost)`**, and the percent of students with a successful outcome is  **`r hr_sucess("M3")`**


1. The number of students who achieved at a high level is **`r nrow(hr_high_df)`**:

2. The number of studens who did not achieve at high level but increased outcome socre **`r nrow(hr_increase_df)`**:




The improvement in outcome scores is graphically represented below. 


```{r"hr_2016", echo=FALSE}

hr_2016 <- hr_all %>%
    filter(Year_Id =="M3")

```



```{r "hr_histo", echo=FALSE}
pre_hr_histq <- qplot(hr_2016$Pre, geom="histogram", main= "Pre Survey",ylim=c(0,20), bins=40, xlab="Outcome Scores") + geom_vline(xintercept = 4.45, col="red") 


post_hr_histq <-qplot(hr_2016$Post, geom="histogram", main= "Post Survey", bins=40, xlab="Outcome Scores", ylim=c(0,20)) + geom_vline(xintercept = 4.45, col="red")

grid.arrange(pre_hr_histq, post_hr_histq, ncol=2)


```

The percent of students who achieved the healthy releationship at a high level is **`r hr_achieved("M3")`**. The imrovement is represented graphically below. 

```{r "hr_bar_2016", echo=FALSE}
hr_bar_pre <-qplot(hr_2016$Pre >=4.45, geom="bar", ylim=c(0, 100), main="Pre survey Results", xlab="Achievment at High Level")

hr_bar_post <-qplot(hr_2016$Post >=4.45, geom ="bar",ylim=c(0,100), main="Post Survey Results", xlab="Achievment at High Level")

grid.arrange(hr_bar_pre, hr_bar_post, ncol=2)


```

```{r "hr_change", echo=FALSE}
healthy_change <- filter(healthy_prepost, Pre !=6.0 & Post !=6.0)


```



The percent of students who went from low achievment to high achievement **`r hr_lowHigh("M3")`**. The number of students who had the opportunity to improve their healthy relationship outcome score is **`r nrow(healthy_change)`**, and the mean increase in outcome score is **`r mean(healthy_change$hr.diff)`**

The increase in the healthy relationship outcome scores is represented graphically below. Marks to the right of the veticial red line represents an increase in the outcome score. Marks above the horizintal line represents scores above the high and low achievement. 


```{r function_test, echo=FALSE, eval=FALSE}

high <-filter(healthy_prepost, Post >=4.45)

high <- nrow(high)

high


low_increase <-filter(healthy_prepost, Post < 4.45 & hr.diff >0)

head(low_increase)
tail(low_increase)
nrow(low_increase)

low_increase <-nrow(low_increase)

hr_success <- (high + low_increase)/nrow(healthy_prepost)

pander(hr_success)


not_pre <-filter(healthy_prepost, Pre <4.45 & Post >=4.45)

not_pre

not_pre <-nrow(not_pre)/nrow(healthy_prepost)

pander(not_pre)

```





```{r "plot_hr_change", echo=FALSE}




healthy_change_p <- ggplot(hr_2016,(aes(x=hr.diff, y=Pre)))
healthy_change_p + geom_count() + geom_hline(yintercept = 4.45) + geom_vline(xintercept = 0, col="red") + labs(x="Pre and Post Difference", y="Pre Outcome Score", title="Healthy Releationship Survey Results")



```

