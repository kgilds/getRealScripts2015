---
title: "Attendance"
author: "Kevin Gilds, MPA"
date: "`r Sys.Date()`"
output: html_document
---


```{r echo=FALSE, warning=FALSE, message=FALSE}


#load the libaries
library(dplyr)
library(dplyr)
library(pander)
library(ggplot2)
library (ezknitr)
library(sqldf)

### set working directory to find the data
setwd("C:/Users/kevin/Dropbox/GetReal/Data/sqlite")

###Read data from database
getReal_2016db<- dbConnect(SQLite(), dbname="outcome_history.sqlite")

##read q1 data from database
q1_absences <-dbReadTable(getReal_2016db, "Q1_Absences")

##read q2 absences from database
q2_absences <-dbReadTable(getReal_2016db, "Q2_Absences")



```



# Improved Attendance: 

## Objective: 
*60% of participating students will either maintain or improve their attendance rates as demonstrated by their decreased absences from the baseline grading period to the final grading period as evidenced by report cards/school reports.*

```{r echo=FALSE}

#Merge and find matches between q1 and q2 by girlCode
absences <- inner_join(q1_absences, q2_absences, by="girlCode")


##narrow variables of interests
absences_1 <- absences %>%
    select(girlCode, council.x.x, sum_abs.x, sum_abs.y) 
 
###make caluculated field   
absences_q2q1 <- absences_1 %>%
    mutate(abs_diff = sum_abs.y - sum_abs.x)



###Ensure there are no cases with NA
absences_q2q1 <- absences_q2q1 %>%
    filter(abs_diff != "NA")


```


```{r echo=FALSE}

absences_success <- function() {
    no_absences <- filter(absences_q2q1, abs_diff == 0, sum_abs.y ==0) #find cases with no absences
    decrease_abs <- filter(absences_q2q1, abs_diff<0 ) #find students who decreased absences
    abs_total <- nrow(no_absences) + nrow(decrease_abs) #add positive outcomes no absences, decreased absences
    abs_total <- abs_total / nrow(absences_q2q1) #divide positive outcomes by total
    abs_total <- round(abs_total*100,2) #make percent 
    pander(paste0(abs_total, "%", sep= ""))# make percent pretty with percent sign
    
}




```





### Absences Success: % of Students who decreased their absences or had no absences. 
```{r echo=FALSE}

abs_diff<- pander(mean(absences_q2q1$abs_diff, na.rm=TRUE))  #find mean differences


```



The number of valid entries is **`r nrow(absences_q2q1)`**, and the number of students who decreased their absences or did not miss any days is **`r absences_success()`**. The average difference of absences  between Quarter 1 and Quarter 2 is **`r abs_diff`**.


### Absences Change Table:
```{r echo=FALSE, eval=TRUE}

absences_change <- with(absences_q2q1, table(abs_diff))  #make table with absences differnces

pander(absences_change) #make table pretty



#absences_change_1 <-with(absences_q2q1,table(abs_diff <0))

#absences_change_2 <-with(absences_q2q1,table(abs_diff ==0, sum_abs.y == 0))

#absences_change_3 <-with(absences_q2q1,table(sum_abs.x == 0, sum_abs.y == 0))

#pander(absences_change_2)

#pander(absences_change_3)


#pander(absences_change_1)

#plot(absences_change)

```




```{r echo=FALSE}

colnames (absences_q2q1) [2] <- "Council"  #chanage name to make pretty for graph
colnames (absences_q2q1) [3] <- "Q1_Abs"  #change name to make pretty for graph
colnames (absences_q2q1) [4] <- "Q2_Abs" # change name to make pretty for graph
colnames (absences_q2q1) [5] <- "Abs_Change" #change name to make pretty for graph

```

### Plot of Change in Absences:

The plot below has the council on the vertical axis and the difference in absences between Quarter 1 and Quarter 2. For this plot it is good to see the circles on the left to reflect decreases. 


```{r echo=FALSE, warning=FALSE}

abs_change_plot_c <- ggplot(absences_q2q1,(aes(x = Abs_Change, y = Council)))

abs_change_plot_c + geom_count()  #plot changes in absences by council



#abs_change_plot2 <- ggplot(absences_q2q1,(aes(x = Abs_Change, y = Q1_Abs)))

#abs_change_plot2 + geom_count()

```

### Trend Data
````{r echo=FALSE, warning=FALSE, message=FALSE}

### Change working directory to where database is 
setwd("C:/Users/kevin/Dropbox/GetReal/Reports/MY-2014-2015/Summ Evaluation Report/data")

#connect to database where data is 
getRealdb<- dbConnect(SQLite(), dbname="data_Final_GetReal_2014_2015.sqlite")

###pull out absence data from 2015
abs_2015 <- dbReadTable(getRealdb, "absences_final")


```


```{r echo=FALSE, warning=FALSE, message=FALSE}
# match data

#Merge and find matches
abs_match <- inner_join(q2_absences, abs_2015)



#Create calculated field to find difference in absences from q4 to q2
abs_match <- abs_match %>%
    mutate(abs_match$total_abs_final - abs_match$sum_abs)


##change column name to give variable name to caluclated field
colnames(abs_match)[11] <-"abs_match_trend"




```




```{r echo=FALSE}
abs_match_success <- function() {
    abs_data_m_none <- filter(abs_match, sum_abs == 0, total_abs_final ==0) #find studens with no absence
    abs_data_m <-filter(abs_match, abs_match_trend <0) #find students who decreased abssences
    abs_data_2m <- nrow(abs_data_m_none) + nrow(abs_data_m) #add positive outcome together
    abs_data_1m <- abs_data_2m/nrow(abs_match) #divide postive outcomes by total
    abs_data_percent1 <- round(abs_data_1m*100,2) #create percent
    pander(paste0(abs_data_percent1, "%", sep=""))#make pretty and add percent sign
}



```


```{r echo=FALSE}
abs_match_m<- mean(abs_match$abs_match_trend)

abs_match_m <- round(abs_match_m,2)

```



The number of students that could be matched is **`r nrow(abs_match)`**, and the mean attendance change from Quarter 4 to Quarter 2 is **`r (abs_match_m)`**.  The vast majority of students are improving their attendance rates. The mean difference is reflecting three students with a high number of absences. The percent of students who have improved their attendance from Quarter 4 last year is **`r abs_match_success()`**


### Plot of Absences Change by Council:

```{r echo=FALSE}

colnames(abs_match)[1] <- "Council" #change name to make pretty for graph
colnames(abs_match)[11]<- "Absences_Change" #change name to make pretty for graph

absence_change_plot_m <- ggplot(abs_match,(aes(x = Absences_Change, y = Council)))

absence_change_plot_m + geom_count()  #display changes in absences by council


```





### Plot change in absence by Student: 
```{r echo=FALSE}


plot(abs_match$Absences_Change, ylab="Difference in Absences", xlab="Matched Students")
abline(h=0, col="red") #plot change by student


```

